# Deep Gravity: enhancing mobility flows generation with deep neural networks and geographic information

a PyTorch implementation of the paper: 
```
F. Simini, G. Barlacchi, M. Luca, L. Pappalardo, 
Deep Gravity: enhancing mobility flows generation with deep neural networks and geographic information
https://arxiv.org/abs/2012.00489
```

Please cite it if you use the code in this repository:
```
@misc{simini2021deep,
      title={Deep Gravity: enhancing mobility flows generation with deep neural networks and geographic information}, 
      author={Filippo Simini and Gianni Barlacchi and Massimiliano Luca and Luca Pappalardo},
      year={2021},
      eprint={2012.00489},
      archivePrefix={arXiv},
      primaryClass={cs.LG}
}
```

## Abstract
The movements of individuals within and among cities influence critical aspects of our society, such as well-being, the spreading of epidemics, and the quality of the environment. When information about mobility flows is not available for a particular region of interest, we must rely on mathematical models to generate them.

**Deep Gravity** is an effective method to generate flow probabilities that exploits many variables (e.g., land use, road network, transport, food, health facilities) extracted from voluntary geographic data, and uses deep neural networks to discover non-linear relationships between those variables and mobility flows. 

Our experiments, conducted on mobility flows in England, Italy, and New York State, show that Deep Gravity has good geographic generalization capability, achieving a significant increase in performance (especially in densely populated regions of interest) with respect to the classic gravity model and models that do not use deep neural networks or geographic data. We also show how flows generated by Deep Gravity may be explained in terms of the geographic features using explainable AI techniques.

![Performances of DG vs G in an highly populated area in England](https://github.com/scikit-mobility/DeepGravity/blob/master/imgs/plot.png?raw=true)
_Figure 1. Performances in terms of Common Part of Commuters (CPC) of Deep Gravity (DG) vs the gravity model (G) in an highly populated area in England_

## Setup

Before running the model, you should set up an environment as indicated [here](https://github.com/kaust-vislab/horovod-gpu-data-science-project)
and you have to make sure you have the following dependencies installed:

- `pytorch 1.7.1`
- `numpy 1.19.2`
- `pandas 1.2.4`
- `geopandas 0.9.0`
- `scikit-mobility 1.1.0`
- `area`
- `folium 0.12.1`

## Running Deep Gravity

Once you installed all the packages correctly, you can run the experiments for all the models listed in the paper (DG, G, MFG, NG).
To do so, you have to run the following command:

`mpirun -np 2 python deepgravity_horovod.py --device gpu --seed 42 --momentum 0.9 --lr 5e-6 --epochs 20 --batch_size 64 --test-batch-size 64 --no-round 0 --model-type DG --country uk >& ../results/log_dg_DG_uk_0.out`

while the arguments device, seed, momentum, lr, epochs, batch_size and test_batch_size are hyperparameters of the model, the last arguments are what allow you to select which model to train and which data to use.
In particular, with no-round, you can select which train and test split you want to use. The name of the files are train_tiles_N.csv and test_tiles_N.csv and N is the number to use. For example, by setting `no-round` to 0 you will use `train_tiles_0.csv` and `test_tiles_0.csv` and train and test sets.
`model-type` is an argument that can take values in DG, G, MFG, NG and allows you to select the model you desire to train while the argument `country` allows you to select the country on which you want to train the model.
Finally, you can specify the path to a file on which you will find the logs produced by the script.

Once your model is trained, you will find the results of the test phase in a file in the results directory. The file will be named `tile2cpc_<model-type>_<country>_<no-round>.csv`. In the same folder, you will also find the trained model named `model_<model-type>_<country>_<no-round>.pt`

## Plot of the results

Once you have the results for all the four models in at least a country and at least for one no-round, you can reproduce Figure 3 and Table 1 of the paper using the notebook `plot_results.ipynb`

## Additional Data

The datasets used in the experiments can be found at:
- England
  - [https://census.ukdataservice.ac.uk/use-data/guides/flow-data.aspx](https://census.ukdataservice.ac.uk/use-data/guides/flow-data.aspx)
  - [https://census.ukdataservice.ac.uk/use-data/guides/boundary-data](https://census.ukdataservice.ac.uk/use-data/guides/boundary-data)
- Italy
  - [http://datiopen.istat.it/datasetPND.php](http://datiopen.istat.it/datasetPND.php)
  - [https://www.istat.it/it/archivio/104317#accordions](https://www.istat.it/it/archivio/104317#accordions)
- New York
  - [https://github.com/GeoDS/COVID19USFlows](https://github.com/GeoDS/COVID19USFlows)
  - [https://www.census.gov/cgi-bin/geo/shapefiles/index.php?year=2020&layergroup=Census+Tracts](https://www.census.gov/cgi-bin/geo/shapefiles/index.php?year=2020&layergroup=Census+Tracts)

Data related to POIs should be retrieved from appropriate services. Examples are Overpass API, HOTosm or - suggested - by downloading a local copy of the OSM database in a PostgreSQL instance and by running appropriate queries. The query we used to retrieved POIs information is available in `osm_query.yaml`
